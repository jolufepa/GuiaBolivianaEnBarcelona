@page "/negocio/{Id}"
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@using BolivianosEnBarcelona.Models

@if (negocio != null)
{
    <PageTitle>@negocio.Name - Guía Boliviana</PageTitle>

    <div class="container mt-4 animate__animated animate__fadeIn mb-5">

        @* ENCABEZADO DE NAVEGACIÓN *@
        <div class="d-flex justify-content-between align-items-center mb-3">
            <a href="directorio" class="btn btn-outline-secondary rounded-pill btn-sm">
                <i class="bi bi-arrow-left"></i> Volver
            </a>

            @* BOTÓN COMPARTIR *@
            <button class="btn btn-primary rounded-pill btn-sm" @onclick="CompartirNegocio">
                <i class="bi bi-share-fill"></i> Compartir
            </button>
        </div>

        @* TARJETA PRINCIPAL *@
        <div class="card shadow rounded-4 overflow-hidden border-0 mb-5">
            <div class="row g-0">
                @* IMAGEN PRINCIPAL: Ajustada para verse entera *@
                <div class="col-md-6 bg-light d-flex align-items-center justify-content-center"
                     style="min-height: 350px;">

                    @if (string.IsNullOrEmpty(negocio.ImageUrl) || negocio.ImageUrl.Contains("default"))
                    {
                        <i class="bi bi-shop display-1 text-muted opacity-25"></i>
                    }
                    else
                    {
                        @* CORRECCIÓN 1: Imagen principal completa (contain) *@
                        <img src="@negocio.ImageUrl"
                             class="img-fluid"
                             style="width: 100%; height: auto; max-height: 500px; object-fit: contain;"
                             alt="@negocio.Name">
                    }
                </div>

                <div class="col-md-6">
                    <div class="card-body p-4 p-lg-5 d-flex flex-column h-100 justify-content-center">
                        <div class="mb-2">
                            <span class="badge bg-primary bg-opacity-10 text-primary px-3 py-2 rounded-pill mb-2">@negocio.Category</span>
                            @if (negocio.IsPromoted)
                            {
                                <span class="badge bg-warning text-dark ms-2"><i class="bi bi-star-fill"></i> Destacado</span>
                            }
                        </div>

                        <h1 class="fw-bold display-6 mb-3">@negocio.Name</h1>
                        <p class="text-muted lead mb-4">@negocio.Description</p>

                        <div class="d-grid gap-2 col-lg-10 mx-auto mx-lg-0">
                            @* DATOS DE CONTACTO *@
                            @if (!string.IsNullOrEmpty(negocio.Address))
                            {
                                <div class="d-flex align-items-center mb-2 p-3 border rounded-3 bg-light">
                                    <i class="bi bi-geo-alt-fill text-danger fs-3 me-3"></i>
                                    <div class="flex-grow-1">
                                        <small class="text-muted d-block">Dirección</small>
                                        <span class="fw-bold d-block text-dark text-decoration-none">@negocio.Address</span>
                                    </div>
                                    @if (negocio.Latitude != 0)
                                    {
                                        <a href="https://www.google.com/maps/dir/?api=1&destination=@negocio.Latitude.ToString(System.Globalization.CultureInfo.InvariantCulture),@negocio.Longitude.ToString(System.Globalization.CultureInfo.InvariantCulture)"
                                           target="_blank"
                                           class="btn btn-outline-danger btn-sm rounded-pill ms-2">
                                            <i class="bi bi-map"></i> Ir
                                        </a>
                                    }
                                </div>
                            }

                            @if (!string.IsNullOrEmpty(negocio.PhoneNumber))
                            {
                                <a href="@negocio.WhatsAppLink" target="_blank"
                                   class="btn btn-success btn-lg rounded-pill shadow-sm d-flex align-items-center justify-content-center gap-2">
                                    <i class="bi bi-whatsapp"></i> Contactar por WhatsApp
                                </a>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @* SECCIÓN: OTROS NEGOCIOS SIMILARES *@
        @if (relacionados.Any())
        {
            <h4 class="fw-bold mb-3 ms-2">También en @negocio.Category...</h4>
            <div class="row">
                @foreach (var item in relacionados)
                {
                    <div class="col-6 col-md-4 mb-3">
                        <div class="card h-100 border-0 shadow-sm">
                            <a href="negocio/@item.Id" class="text-decoration-none">

                                @* CORRECCIÓN 2: Imágenes relacionadas completas.
                                   - Cambiado 'cover' por 'contain'
                                   - Fondo blanco para rellenar espacios si la foto es estrecha
                                   - Aumenté un poco la altura (150px) para que no se vean diminutas *@
                                <div class="bg-white d-flex align-items-center justify-content-center border-bottom" style="height: 150px; width: 100%;">
                                    <img src="@item.ImageUrl"
                                         style="max-height: 100%; max-width: 100%; object-fit: contain;"
                                         alt="@item.Name">
                                </div>

                                <div class="card-body p-3">
                                    <h6 class="card-title text-dark fw-bold text-truncate mb-0">@item.Name</h6>
                                    <small class="text-muted">@item.Address</small>
                                </div>
                            </a>
                        </div>
                    </div>
                }
            </div>
        }
    </div>
}
else if (cargando)
{
    <div class="d-flex justify-content-center align-items-center" style="min-height: 50vh;">
        <div class="spinner-border text-primary" role="status"></div>
    </div>
}
else
{
    <div class="alert alert-danger mt-4 container text-center">
        Negocio no encontrado. <a href="directorio" class="alert-link">Volver al directorio</a>.
    </div>
}

@code {
    [Parameter] public string Id { get; set; }

    Business? negocio;
    List<Business> relacionados = new List<Business>();
    bool cargando = true;

    protected override async Task OnInitializedAsync()
    {
        cargando = true;
        negocio = null;
        relacionados.Clear();

        try
        {
            var todos = await Http.GetFromJsonAsync<Business[]>("data/negocios.json");

            if (todos != null)
            {
                negocio = todos.FirstOrDefault(n => n.Id == Id);

                if (negocio != null)
                {
                    relacionados = todos
                        .Where(n => n.Category == negocio.Category && n.Id != negocio.Id)
                        .OrderBy(x => Guid.NewGuid())
                        .Take(3)
                        .ToList();
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex);
        }
        finally
        {
            cargando = false;
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        if (negocio != null && negocio.Id != Id)
        {
            await OnInitializedAsync();
        }
    }

    async Task CompartirNegocio()
    {
        if (negocio == null) return;

        var url = $"https://www.bolivianosenbarcelona.com/negocio/{negocio.Id}";
        var titulo = $"Mira este negocio: {negocio.Name}";
        var texto = $"Encontré {negocio.Name} en la Guía de Bolivianos en Barcelona. ¡Está buenísimo!";

        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.share", new { title = titulo, text = texto, url = url });
        }
        catch
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Copia este enlace para compartir: {url}");
        }
    }
}
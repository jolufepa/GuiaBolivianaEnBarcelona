@page "/negocio/{Id}"
@inject HttpClient Http
@using BolivianosEnBarcelona.Models
@inject NavigationManager NavManager

<PageTitle>@(negocio?.Name ?? "Detalle del Negocio") - Bolivianos en BCN</PageTitle>

<HeadContent>
    @if (negocio != null)
    {
        <meta name="description" content="@negocio.Description" />

        <meta property="og:type" content="business.business" />
        <meta property="og:title" content="@negocio.Name - Bolivianos en Barcelona" />
        <meta property="og:description" content="@negocio.Description" />
        <meta property="og:image" content="@GetAbsoluteImageUrl(negocio.ImageUrl)" />

        <meta name="twitter:card" content="summary_large_image" />
        <meta name="twitter:title" content="@negocio.Name" />
        <meta name="twitter:description" content="@negocio.Description" />
        <meta name="twitter:image" content="@GetAbsoluteImageUrl(negocio.ImageUrl)" />
    }
</HeadContent>

<div class="container mt-4 mb-5">
    <a href="directorio" class="btn btn-outline-secondary mb-4">
        <i class="bi bi-arrow-left"></i> Volver al Directorio
    </a>

    @if (cargando)
    {
        <div class="text-center mt-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
        </div>
    }
    else if (negocio == null)
    {
        <div class="alert alert-warning text-center">
            <h4>No encontramos este negocio 😕</h4>
            <p>Es posible que haya sido eliminado o el enlace sea incorrecto.</p>
            <a href="directorio" class="btn btn-primary mt-3">Ir al Directorio</a>
        </div>
    }
    else
    {
        <div class="card shadow-lg border-0 overflow-hidden">
            <div style="height: 300px; background-color: #f8f9fa; overflow: hidden; position: relative;">
                <img src="@negocio.ImageUrl" alt="@negocio.Name"
                     style="width: 100%; height: 100%; object-fit: contain; padding: 15px;">

                @if (negocio.IsPromoted)
                {
                    <div class="position-absolute top-0 end-0 m-3">
                        <span class="badge bg-warning text-dark px-3 py-2 fs-6 shadow">⭐ Recomendado</span>
                    </div>
                }
            </div>

            <div class="card-body p-4 p-md-5">
                <div class="row">
                    <div class="col-md-8">
                        <span class="badge bg-primary mb-2">@negocio.Category</span>
                        <h1 class="fw-bold mb-3">@negocio.Name</h1>

                        <p class="lead text-muted mb-4">
                            @negocio.Description
                        </p>

                        <hr class="my-4">

                        <h5 class="fw-bold mb-3">Información de Contacto</h5>
                        <ul class="list-unstyled">
                            <li class="mb-3">
                                <i class="bi bi-geo-alt-fill text-danger me-2 fs-5"></i>
                                <strong>Dirección:</strong>
                                <a href="@($"https://www.google.com/maps/search/?api=1&query={System.Net.WebUtility.UrlEncode(negocio.Address + " Barcelona")}")"
                                   target="_blank"
                                   class="text-decoration-none text-dark hover-underline">
                                    @negocio.Address <small class="text-primary ms-1">(Ver mapa <i class="bi bi-box-arrow-up-right"></i>)</small>
                                </a>
                            </li>
                        </ul>
                    </div>

                    <div class="col-md-4">
                        <div class="card bg-light border-0 p-3 mt-3 mt-md-0">
                            <h5 class="fw-bold mb-3">¿Te interesa?</h5>

                            <a href="@negocio.WhatsAppLink" target="_blank" class="btn btn-success btn-lg w-100 mb-2 py-3">
                                <i class="bi bi-whatsapp"></i> Contactar por WhatsApp
                            </a>

                            @if (!string.IsNullOrEmpty(negocio.PhoneNumber))
                            {
                                <a href="tel:@negocio.PhoneNumber" class="btn btn-outline-dark w-100">
                                    <i class="bi bi-telephone"></i> Llamar: @negocio.PhoneNumber
                                </a>
                            }

                            <p class="small text-muted text-center mt-3 mb-0">
                                <i class="bi bi-shield-check"></i> Negocio verificado.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public string? Id { get; set; }

    private Business? negocio;
    private bool cargando = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // 1. Generamos el número de versión (el truco anti-caché)
            var version = DateTime.Now.Ticks;

            // 2. Añadimos ?v={version} usando el símbolo $
            // Ahora el navegador se verá obligado a bajar el archivo actualizado
            var todos = await Http.GetFromJsonAsync<Business[]>($"data/negocios.json?v={version}");

            if (todos != null && Id != null)
            {
                negocio = todos.FirstOrDefault(n => n.Id == Id);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            cargando = false;
        }
    }

    // Función auxiliar para convertir rutas relativas (Images/...) en absolutas (https://...)
    // Esto es necesario para que WhatsApp muestre la foto.
    private string GetAbsoluteImageUrl(string relativePath)
    {
        if (string.IsNullOrEmpty(relativePath)) return "";
        if (relativePath.StartsWith("http", StringComparison.OrdinalIgnoreCase)) return relativePath; // Si ya es un link externo, lo dejamos.

        // Combina la URL base de tu web con la ruta de la imagen
        return new Uri(new Uri(NavManager.BaseUri), relativePath).ToString();
    }
}
@page "/directorio"
@inject HttpClient Http
@using System.Text
@using System.Globalization
@using BolivianosEnBarcelona.Models

<PageTitle>Directorio - Buscador</PageTitle>

<div class="container mt-4">
    <h2 class="mb-4 fw-bold text-center">Encuentra lo que buscas</h2>

    <div class="input-group mb-4 shadow-sm">
        <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
        <input type="text"
               class="form-control border-start-0"
               placeholder="Buscar por nombre (ej. Salteñas...)"
               @bind="textoBusqueda"
               @bind:event="oninput" />
    </div>

    <div class="d-flex flex-wrap gap-2 mb-4 justify-content-center">
        <button class="btn @(categoriaActual == "" ? "btn-dark" : "btn-outline-dark") rounded-pill px-3"
                @onclick='() => CambiarCategoria("")'>
            Todo
        </button>
        <button class="btn @(categoriaActual == "Gastronomía" ? "btn-danger" : "btn-outline-danger") rounded-pill px-3"
                @onclick='() => CambiarCategoria("Gastronomía")'>
            🥟 Gastronomía
        </button>
        <button class="btn @(categoriaActual == "Legal" ? "btn-primary" : "btn-outline-primary") rounded-pill px-3"
                @onclick='() => CambiarCategoria("Legal")'>
            ⚖️ Legal
        </button>
        <button class="btn @(categoriaActual == "Paquetería" ? "btn-warning" : "btn-outline-warning") rounded-pill px-3"
                @onclick='() => CambiarCategoria("Paquetería")'>
            📦 Paquetería
        </button>

        <button class="btn @(categoriaActual == "Viajes" ? "btn-info" : "btn-outline-info") rounded-pill px-3"
                @onclick='() => CambiarCategoria("Viajes")'>
            ✈️ Viajes
        </button>

        <button class="btn @(categoriaActual == "Otros Servicios" ? "btn-secondary" : "btn-outline-secondary") rounded-pill px-3"
                @onclick='() => CambiarCategoria("Otros Servicios")'>
            ✂️ Otros Servicios
        </button>
    </div>

    <p class="text-muted small mb-3">
        Mostrando <strong>@NegociosFiltrados.Count</strong> resultados
        @(string.IsNullOrEmpty(categoriaActual) ? "" : $"en {categoriaActual}")
    </p>

    <div class="row">
        @if (NegociosFiltrados.Any())
        {
            @foreach (var negocio in NegociosFiltrados)
            {
                <div class="col-md-4 mb-4">
                    <div class="card h-100 shadow-sm border-0 hover-effect">
                        <div style="height: 200px; overflow: hidden; position: relative; background-color: #f8f9fa;">
                            <a href="negocio/@negocio.Id">
                                <img src="@negocio.ImageUrl"
                                     class="card-img-top w-100 h-100"
                                     style="object-fit: contain; padding: 15px;"
                                     alt="@negocio.Name">
                            </a>
                            @if (negocio.IsPromoted)
                            {
                                <div class="position-absolute top-0 end-0 m-2">
                                    <span class="badge bg-warning text-dark">Destacado</span>
                                </div>
                            }
                        </div>
                        <div class="card-body">
                            <span class="badge bg-light text-dark border mb-2">@negocio.Category</span>
                            <h5 class="card-title fw-bold">
                                <a href="negocio/@negocio.Id" class="text-decoration-none text-dark">@negocio.Name</a>
                            </h5>
                            <p class="card-text text-muted small text-truncate">@negocio.Description</p>
                            <p class="card-text small mb-0"><i class="bi bi-geo-alt text-danger"></i> @negocio.Address</p>
                        </div>
                        <div class="card-footer bg-white border-0 pb-3">
                            <div class="d-grid gap-2">
                                <a href="negocio/@negocio.Id" class="btn btn-outline-primary btn-sm">Ver Detalles</a>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12 text-center py-5">
                <div class="mb-3">
                    <i class="bi bi-search fs-1 text-muted opacity-50"></i>
                </div>
                <h4 class="text-muted">No encontramos resultados para "@textoBusqueda"</h4>
                <p class="text-muted mb-4">¿Conoces algún negocio o servicio que debería estar aquí?</p>

                <div class="d-flex justify-content-center gap-3 flex-wrap">
                    <button class="btn btn-outline-dark" @onclick='() => { textoBusqueda = ""; categoriaActual = ""; }'>
                        Limpiar filtros y ver todo
                    </button>
                    <a href="https://docs.google.com/forms/d/e/1FAIpQLSf6KU43yHT_bt8mIoNTKHN-tobB6-eTNhPkqXP-1Z0imKnvtg/viewform?usp=dialog"
                       target="_blank"
                       class="btn btn-primary">
                        <i class="bi bi-plus-circle"></i> Registrar ese Negocio
                    </a>
                </div>
            </div>
        }
    </div>
</div>

@code {
    List<Business> todosLosNegocios = new List<Business>();
    string textoBusqueda = "";
    string categoriaActual = ""; // Variable para el filtro de botones

    
    // Filtro combinado: Texto AND Categoría (¡Ahora insensible a acentos!)
    List<Business> NegociosFiltrados
    {
        get
        {
            // 1. Limpiamos el texto de búsqueda
            var terminoLimpio = QuitarAcentos(textoBusqueda).ToLower();

            // 2. Limpiamos TAMBIÉN la categoría seleccionada (ej: "Gastronomía" -> "gastronomia")
            var categoriaLimpia = QuitarAcentos(categoriaActual).ToLower();

            return todosLosNegocios
                .Where(n =>
                    (string.IsNullOrEmpty(terminoLimpio) ||
                     QuitarAcentos(n.Name).ToLower().Contains(terminoLimpio) ||
                     QuitarAcentos(n.Description).ToLower().Contains(terminoLimpio))
                    &&
                    // AQUÍ ESTÁ EL CAMBIO MAGICO:
                    // Comparamos la categoría del negocio limpia contra la del botón limpia
                    (string.IsNullOrEmpty(categoriaLimpia) ||
                     QuitarAcentos(n.Category ?? "").ToLower() == categoriaLimpia)
                )
                .ToList();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // 1. Generamos el sello de tiempo (truco anti-caché)
            var version = DateTime.Now.Ticks;

            // 2. Inyectamos la variable {version} en la URL
            // Así el navegador cree que es un archivo nuevo y lo descarga sí o sí
            var datos = await Http.GetFromJsonAsync<Business[]>($"data/negocios.json?v={version}");

            if (datos != null) todosLosNegocios = datos.ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
    }

    void CambiarCategoria(string cat)
    {
        categoriaActual = cat;
        // Opcional: Limpiar texto al cambiar categoría para no confundir
        // textoBusqueda = "";
    }
    // Función auxiliar para normalizar texto (quitar tildes y diéresis)
    string QuitarAcentos(string texto)
    {
        if (string.IsNullOrWhiteSpace(texto)) return string.Empty;

        // 1. Normalizamos a formato KD (separa la letra 'á' en 'a' + '´')
        var normalizedString = texto.Normalize(NormalizationForm.FormD);
        var stringBuilder = new StringBuilder();

        foreach (var c in normalizedString)
        {
            // 2. Nos quedamos solo con los caracteres que NO son marcas de acento
            var unicodeCategory = CharUnicodeInfo.GetUnicodeCategory(c);
            if (unicodeCategory != UnicodeCategory.NonSpacingMark)
            {
                stringBuilder.Append(c);
            }
        }

        // 3. Devolvemos el texto limpio y normalizado a formato C
        return stringBuilder.ToString().Normalize(NormalizationForm.FormC);
    }
}